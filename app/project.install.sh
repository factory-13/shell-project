#!/usr/bin/env bash

# -------------------------------------------------------------------------------------------------------------------- #
# Install projects.
# -------------------------------------------------------------------------------------------------------------------- #
# @author Kitsune Solar <kitsune.solar@gmail.com>
# @version 1.0.0
# -------------------------------------------------------------------------------------------------------------------- #

# -------------------------------------------------------------------------------------------------------------------- #
# Add user.
# -------------------------------------------------------------------------------------------------------------------- #

ext.project.install.user() {
    username="${1}"
    user="web_${username}"

    useradd -b /home/storage/projects -m -s /bin/zsh ${user} && passwd ${user}
}

# -------------------------------------------------------------------------------------------------------------------- #
# Create directories.
# -------------------------------------------------------------------------------------------------------------------- #

ext.project.install.directory() {
    mkdir -p ${HOME}/{.auth,.logs,.temp}
    mkdir -p ${HOME}/.temp/php/{opcache,session,upload,wsdlcache}
    mkdir -p ${HOME}/domain/public_html
    mkdir -p ${HOME}/subdomain
}

# -------------------------------------------------------------------------------------------------------------------- #
# Create Apache & Nginx virtual host.
# -------------------------------------------------------------------------------------------------------------------- #

ext.project.install.vhost() {
    username="${1}"
    domain="${2}"
    user="web_${username}"

    cat > /etc/httpd/vhosts.d/${domain}.ssl.conf <<EOF
# -------------------------------------------------------------------------------------------------------------------- #
# VirtualHost: ${domain}
# -------------------------------------------------------------------------------------------------------------------- #
# @author       Kitsune Solar <kitsune.solar@gmail.com>
# @version      1.0.0-SSL
# @package      httpd
# -------------------------------------------------------------------------------------------------------------------- #

<VirtualHost 127.0.0.1:8081>

    # ---------------------------------------------------------------------------------------------------------------- #
    # Meta.
    # ---------------------------------------------------------------------------------------------------------------- #

    AssignUserID                        ${user} ${user}
    ServerAdmin                         webmaster@localhost
    DocumentRoot                        "/home/storage/projects/${user}/domain/public_html/"
    ServerName                          ${domain}
    ServerAlias                         www.${domain}

    # ---------------------------------------------------------------------------------------------------------------- #
    # Directory.
    # ---------------------------------------------------------------------------------------------------------------- #

    <Directory "/home/storage/projects/${user}/domain/public_html/">
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    # ---------------------------------------------------------------------------------------------------------------- #
    # PHP.
    # ---------------------------------------------------------------------------------------------------------------- #

    php_value session.save_path         "/home/storage/projects/${user}/.temp/php/session"

    # ---------------------------------------------------------------------------------------------------------------- #
    # SSL.
    # ---------------------------------------------------------------------------------------------------------------- #

    SSLEngine                           on
    SSLCertificateFile                  "/home/storage/apps/app_certbot/.acme/certs/${domain}/cert.pem"
    SSLCertificateKeyFile               "/home/storage/apps/app_certbot/.acme/certs/${domain}/privkey.pem"
    SSLCertificateChainFile             "/home/storage/apps/app_certbot/.acme/certs/${domain}/chain.pem"

    # ---------------------------------------------------------------------------------------------------------------- #
    # Log.
    # ---------------------------------------------------------------------------------------------------------------- #

    ErrorLog                            /home/storage/projects/${user}/.logs/error.${domain}.log
    CustomLog                           /dev/null common

</VirtualHost>
EOF

    cat > /etc/nginx/vhosts.d/${domain}.ssl.proxy.conf <<EOF
# -------------------------------------------------------------------------------------------------------------------- #
# VirtualHost: ${domain}
# -------------------------------------------------------------------------------------------------------------------- #
# @author       Kitsune Solar <kitsune.solar@gmail.com>
# @version      1.0.0-SSL
# @package      nginx
# -------------------------------------------------------------------------------------------------------------------- #

server {

    # ---------------------------------------------------------------------------------------------------------------- #
    # Server name & IP.
    # ---------------------------------------------------------------------------------------------------------------- #

    listen                              443 ssl http2;
    server_name                         ${domain};

    # ---------------------------------------------------------------------------------------------------------------- #
    # Logs.
    # ---------------------------------------------------------------------------------------------------------------- #

    access_log off;

    # ---------------------------------------------------------------------------------------------------------------- #
    # SSL.
    # ---------------------------------------------------------------------------------------------------------------- #

    ssl                                 on;
    ssl_certificate                     "/home/storage/apps/app_certbot/.acme/certs/${domain}/fullchain.pem";
    ssl_certificate_key                 "/home/storage/apps/app_certbot/.acme/certs/${domain}/privkey.pem";
    ssl_trusted_certificate             "/home/storage/apps/app_certbot/.acme/certs/${domain}/chain.pem";

    # ---------------------------------------------------------------------------------------------------------------- #
    # Location.
    # ---------------------------------------------------------------------------------------------------------------- #

    location / {
        proxy_pass https://127.0.0.1:8081/;
    }

    location /.well-known/acme-challenge {
        alias /home/storage/apps/app_certbot/.acme/challenges;
    }

}

# -------------------------------------------------------------------------------------------------------------------- #
# VirtualHost: www.${domain}
# -------------------------------------------------------------------------------------------------------------------- #
# @author       Kitsune Solar <kitsune.solar@gmail.com>
# @version      1.0.0-SSL
# @package      nginx
# -------------------------------------------------------------------------------------------------------------------- #

server {

    # ---------------------------------------------------------------------------------------------------------------- #
    # Server name & IP.
    # ---------------------------------------------------------------------------------------------------------------- #

    listen                              443 ssl http2;
    server_name                         www.${domain};

    # ---------------------------------------------------------------------------------------------------------------- #
    # Logs.
    # ---------------------------------------------------------------------------------------------------------------- #

    access_log off;

    # ---------------------------------------------------------------------------------------------------------------- #
    # SSL.
    # ---------------------------------------------------------------------------------------------------------------- #

    ssl                                 on;
    ssl_certificate                     "/home/storage/apps/app_certbot/.acme/certs/${domain}/fullchain.pem";
    ssl_certificate_key                 "/home/storage/apps/app_certbot/.acme/certs/${domain}/privkey.pem";
    ssl_trusted_certificate             "/home/storage/apps/app_certbot/.acme/certs/${domain}/chain.pem";

    # ---------------------------------------------------------------------------------------------------------------- #
    # Redirect.
    # ---------------------------------------------------------------------------------------------------------------- #

    return 301 \$scheme://${domain}\$request_uri;
}
EOF
}
